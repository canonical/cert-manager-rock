[tox]
skipsdist = True
envlist = pack, export-to-docker, sanity, integration
skip_missing_interpreters = True

[testenv]

[testenv:pack]
passenv = *
allowlist_externals =
    rockcraft
commands =
    rockcraft pack

[testenv:export-to-docker]
passenv = *
allowlist_externals =
    bash
    skopeo
    yq
commands =
# export rock to docker
    bash -c 'NAME=$(yq eval .name rockcraft.yaml) && \
    VERSION=$(yq eval .version rockcraft.yaml) && \
    ARCH=$(yq eval ".platforms | keys | .[0]" rockcraft.yaml) && \
    ROCK="$\{NAME\}_$\{VERSION\}_$\{ARCH\}.rock" && \
    DOCKER_IMAGE=$NAME:$VERSION && \
    echo "Exporting $ROCK to docker as $DOCKER_IMAGE" && \
    skopeo --insecure-policy copy oci-archive:$ROCK docker-daemon:$DOCKER_IMAGE'

[testenv: {test,sanity}]
passenv = *

allowlist_externals =
    bash
    skopeo
    yq
deps =
    pytest
    charmed-kubeflow-chisme

commands =
    bash -c 'NAME=$(yq eval .name rockcraft.yaml) && \
    pytest {tox_root}/tests_commons/test_rock.py::test_rock_smoke[$NAME]

[testenv: lint]
allowlist_externals =
    flake8

commands =
    flake8 {tox_root}/tests_commons

[flake8]
max-line-length = 120
select = E,W,F,C,N
ignore = W503
exclude = venv,.git,.tox,.tox_env,.venv,build,dist,*.egg_info
show-source = true
